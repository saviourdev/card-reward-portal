<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel - Approve Users</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #0b0c10;
  color: #e9eef3;
  margin: 0;
  padding: 20px;
}
h1 {
  text-align: center;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  padding: 10px;
  border: 1px solid #23262d;
  text-align: left;
}
tr:nth-child(even) {
  background: #111318;
}
button {
  padding: 6px 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}
.approve-btn {
  background: #22c55e;
  color: #052e13;
}
.reject-btn {
  background: #ef4444;
  color: white;
}
</style>
</head>
<body>

<h1>Admin Panel</h1>
<table id="usersTable">
  <thead>
    <tr>
      <th>Name</th>
      <th>Phone</th>
      <th>Balance</th>
      <th>Pending?</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC24O6ZV8kHo9rqTr88ERBsRLgbK_Dez8k",
  authDomain: "admin-panel-database-6e378.firebaseapp.com",
  projectId: "admin-panel-database-6e378",
  storageBucket: "admin-panel-database-6e378.firebasestorage.app",
  messagingSenderId: "296556886458",
  appId: "1:296556886458:web:dfd1382b99a6b774ec0583"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const usersTableBody = document.querySelector("#usersTable tbody");

// Listen for all users in real-time
onSnapshot(collection(db, "users"), snapshot => {
  usersTableBody.innerHTML = "";
  snapshot.forEach(userDoc => {
    const data = userDoc.data();
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${data.name || "-"}</td>
      <td>${data.phone || "-"}</td>
      <td>${data.balance?.toFixed(2) || "0.00"} PLN</td>
      <td>${data.pendingApproval ? "✅ Yes" : "❌ No"}</td>
      <td>
        <button class="approve-btn">Approve</button>
        <button class="reject-btn">Reject</button>
      </td>
    `;

    // ✅ Approve button with prompt
    row.querySelector(".approve-btn").addEventListener("click", async () => {
      let amountStr = prompt(`Enter amount to credit for ${data.name || data.phone}:`, "100");
      if (!amountStr) return; // Cancelled
      const amount = parseFloat(amountStr);
      if (isNaN(amount) || amount <= 0) {
        alert("Invalid amount. Please enter a number greater than 0.");
        return;
      }

      const newBalance = (data.balance || 0) + amount;
      await updateDoc(doc(db, "users", userDoc.id), {
        balance: newBalance,
        pendingApproval: false
      });
      alert(`✅ Approved ${data.name || data.phone}\nNew balance: ${newBalance.toFixed(2)} PLN`);
    });

    // ❌ Reject button
    row.querySelector(".reject-btn").addEventListener("click", async () => {
      const confirmDelete = confirm(`Are you sure you want to reject ${data.name || data.phone}?`);
      if (!confirmDelete) return;
      await deleteDoc(doc(db, "users", userDoc.id));
      alert(`❌ Rejected ${data.name || data.phone} - user removed`);
    });

    usersTableBody.appendChild(row);
  });
});
</script>
</body>
</html>